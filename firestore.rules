/**
 * This ruleset governs access to the Firestore database for the Ascend Wealth
 * Customer Management module.
 *
 * Core Philosophy:
 * The rules enforce a secure-by-default posture. All access requires user
 * authentication. The primary collection, 'families', is configured to be
 * readable by any authenticated user to support shared CRM-style functionality.
 * However, all write operations (create, update, delete) are currently
 * disabled as a critical security measure.
 *
 * Data Structure:
 * The database uses a single, flat collection structure:
 * - /families/{familyId}: Stores all information about a customer family.
 *
 * Key Security Decisions:
 * - Read-Only Access: All authenticated users can read the list of families
 *   and individual family documents. This supports the main table view of the
 *   application.
 * - Writes Disabled by Default: All write operations are explicitly disabled
 *   on the `/families` collection. This is a deliberate choice because the
 *   'Family' data model currently lacks an ownership field (e.g., 'creatorId'
 *   or 'ownerId'). Without this field, it's impossible to securely determine
 *   who is allowed to create, modify, or delete a record. This prevents a
 *   scenario where any user could modify any other user's data.
 * - Denormalization for Authorization: To enable writes, the 'Family' documents
 *   MUST be updated to include an ownership field (e.g., `creatorId: request.auth.uid`).
 *   This denormalization is essential for writing simple, performant, and
 *   secure rules that do not require costly 'get' or 'exists' calls to other
 *   documents for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description
     *   Manages access to family records. This rule allows any authenticated
     *   user to read family data but blocks all write operations. Writes are
     *   disabled until an ownership field (e.g., 'creatorId') is added to the
     *   Family document schema to securely authorize modifications.
     * @path
     *   /families/{familyId}
     * @allow
     *   (get, list) A signed-in user reads the list of families for the main table view.
     * @deny
     *   (create) Any user attempts to create a new family record. This is denied
     *   because there is no way to assign and verify ownership on creation.
     * @principle
     *   Secure-by-default posture. Disables writes on collections that lack a
     *   clear ownership model to prevent unauthorized data modification.
     */
    match /families/{familyId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      
      // CRITICAL: Cannot implement owner-only writes. The 'Family' entity is missing an ownership field like 'creatorId'.
      // This prevents securely validating that the user creating the document is its owner, or that a user updating/deleting it has permission.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field (e.g., request.resource.data.creatorId == request.auth.uid).
      allow update: if false; // TODO: Add owner validation (e.g., resource.data.creatorId == request.auth.uid).
      allow delete: if false; // TODO: Add owner validation (e.g., resource.data.creatorId == request.auth.uid).
    }
  }
}